var ChatPPA123456;(()=>{"use strict";var t={848:(t,e,s)=>{s.d(e,{b:()=>a});class a{target;textarea;button;clearButton;cancelButton;statusOutput;resultOutput;debugOutput;host;abortController;apiKey="";assistantId="";modelo="";debug="true";fontSize=14;constructor(t){this.target=t.element,this.host=t.host;const e=document.createElement("div");e.className="chat-container",this.textarea=document.createElement("textarea"),this.textarea.className="chat-input",this.textarea.placeholder="Digite sua pergunta...",this.textarea.rows=1,this.textarea.addEventListener("input",()=>{this.textarea.style.height="auto",this.textarea.style.height=this.textarea.scrollHeight+"px"}),this.button=document.createElement("button"),this.button.textContent="Perguntar",this.clearButton=document.createElement("button"),this.clearButton.textContent="Limpar",this.clearButton.onclick=()=>{this.textarea.value="",this.clearLogs("status"),this.clearLogs("result"),this.clearLogs("debug")},this.cancelButton=document.createElement("button"),this.cancelButton.textContent="Interromper",this.cancelButton.disabled=!0,this.cancelButton.onclick=()=>{this.abortController&&(this.abortController.abort(),this.cancelButton.disabled=!0,this.button.disabled=!1,this.logOutput("⛔ Requisição cancelada pelo usuário.","status"))};const s=document.createElement("div");s.className="chat-buttons",s.appendChild(this.button),s.appendChild(this.cancelButton),s.appendChild(this.clearButton),this.statusOutput=document.createElement("div"),this.statusOutput.className="chat-status",this.resultOutput=document.createElement("div"),this.resultOutput.className="chat-result",this.debugOutput=document.createElement("div"),this.debugOutput.className="chat-debug",e.appendChild(this.textarea),e.appendChild(s),e.appendChild(this.statusOutput),e.appendChild(this.resultOutput),e.appendChild(this.debugOutput),this.target.appendChild(e),this.button.onclick=async()=>{if(this.button.disabled=!0,this.cancelButton.disabled=!1,this.abortController=new AbortController,!(this.textarea&&this.apiKey&&this.assistantId&&this.modelo))return this.logOutput("Preencha todos os campos no painel de formatação.","status"),this.button.disabled=!1,void(this.cancelButton.disabled=!0);this.clearLogs("status"),this.logOutput("⏳ Criando nova thread...","status");try{const t=await fetch("https://api.openai.com/v1/threads",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},signal:this.abortController.signal}),e=(await t.json()).id;this.logOutput("📤 Enviando pergunta...","status"),"true"==this.debug&&this.logOutput("Thread ID: "+e,"debug"),await fetch(`https://api.openai.com/v1/threads/${e}/messages`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({role:"user",content:this.textarea.value}),signal:this.abortController.signal});const s=await fetch(`https://api.openai.com/v1/threads/${e}/runs`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({assistant_id:this.assistantId}),signal:this.abortController.signal}),a=(await s.json()).id;let i="",n=0;do{const t=await fetch(`https://api.openai.com/v1/threads/${e}/runs/${a}`,{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"},signal:this.abortController.signal});i=(await t.json()).status,"completed"!==i&&await new Promise(t=>setTimeout(t,1500)),n++}while("completed"!==i&&n<20);const o=await fetch(`https://api.openai.com/v1/threads/${e}/messages`,{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"},signal:this.abortController.signal}),r=(await o.json()).data.reverse().find(t=>"assistant"===t.role);this.clearLogs("status"),this.logOutput(r?.content[0]?.text?.value||"Sem resposta.","result")}catch(t){"AbortError"===t.name?this.logOutput("⛔ Requisição cancelada.","status"):(this.logOutput("❌ Erro ao processar a requisição.","result"),this.logOutput(t.message,"debug"))}finally{this.abortController=void 0,this.cancelButton.disabled=!0,this.button.disabled=!1}}}logOutput(t,e){const s=document.createElement("pre");s.style.margin="0",s.style.setProperty("font-size",`${this.fontSize}px`,"important"),s.style.lineHeight="1.3em",s.innerText=t,"status"===e?(this.statusOutput.innerHTML="",this.statusOutput.appendChild(s)):"result"===e?this.resultOutput.appendChild(s):"debug"===e&&"true"===this.debug&&this.debugOutput.appendChild(s)}clearLogs(t){"status"===t&&(this.statusOutput.innerHTML=""),"result"===t&&(this.resultOutput.innerHTML=""),"debug"===t&&(this.debugOutput.innerHTML="")}update(t){const e=t.dataViews[0]?.metadata?.objects;e&&(this.debug=i(e,"apiSettings","debug","true"),this.apiKey=i(e,"apiSettings","openAiKey",""),this.modelo=i(e,"apiSettings","modelo",""),this.assistantId=i(e,"apiSettings","assistantId",""),this.fontSize=i(e,"apiSettings","fontSize",14),this.textarea&&this.textarea.style.setProperty("font-size",`${this.fontSize}px`,"important"),this.target.querySelectorAll("*").forEach(t=>{const e=t.tagName.toLowerCase();["p","pre","div","span","button","label"].includes(e)&&t.style.setProperty("font-size",`${this.fontSize}px`,"important")}))}enumerateObjectInstances(t){const e=[];return"apiSettings"===t.objectName&&e.push({objectName:t.objectName,properties:{debug:this.debug,openAiKey:this.apiKey,modelo:this.modelo,assistantId:this.assistantId,fontSize:this.fontSize},selector:null}),e}}function i(t,e,s,a){return t?.[e]?.[s]??a}}},e={};function s(a){var i=e[a];if(void 0!==i)return i.exports;var n=e[a]={exports:{}};return t[a](n,n.exports,s),n.exports}s.d=(t,e)=>{for(var a in e)s.o(e,a)&&!s.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var a={};(()=>{s.r(a),s.d(a,{default:()=>n});var t=s(848),e=window.powerbi,i={name:"ChatPPA123456",displayName:"Chat PPA",class:"Visual",apiVersion:"5.3.0",create:e=>{if(t.b)return new t.b(e);throw"Visual instance not found"},createModalDialog:(t,e,s)=>{const a=globalThis.dialogRegistry;t in a&&new a[t](e,s)},custom:!0};void 0!==e&&(e.visuals=e.visuals||{},e.visuals.plugins=e.visuals.plugins||{},e.visuals.plugins.ChatPPA123456=i);const n=i})(),ChatPPA123456=a})();